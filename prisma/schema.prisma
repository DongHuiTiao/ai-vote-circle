// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表（SecondMe OAuth 认证）
model User {
  id             String   @id @default(cuid())
  secondmeUserId String   @unique @map("secondme_user_id")
  accessToken    String   @map("access_token")
  refreshToken   String   @map("refresh_token")
  tokenExpiresAt DateTime @map("token_expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关联关系
  votes          Vote[]
  voteResponses  VoteResponse[]
  comments       Comment[]
  sessions       ChatSession[]

  @@map("users")
}

// 投票表
model Vote {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // single, multiple, rating, ranking, ab_test
  options     Json     // 投票选项
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联关系
  creator     User     @relation(fields: [createdBy], references: [id])
  responses   VoteResponse[]

  @@map("votes")
}

// 投票响应表
model VoteResponse {
  id        String   @id @default(cuid())
  voteId    String   @map("vote_id")
  userId    String   @map("user_id")
  choice    Json     // 选择的答案
  reason    String?  // 投票理由
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  vote      Vote     @relation(fields: [voteId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
  comments  Comment[]

  @@unique([voteId, userId])
  @@map("vote_responses")
}

// 评论表
model Comment {
  id         String   @id @default(cuid())
  content    String
  responseId String   @map("response_id")
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // 关联关系
  response   VoteResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id])

  @@map("comments")
}

// 聊天会话表
model ChatSession {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联关系
  user      User     @relation(fields: [userId], references: [id])
  messages  ChatMessage[]

  @@map("chat_sessions")
}

// 聊天消息表
model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String   @map("session_id")
  role      String   // user, assistant
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}
