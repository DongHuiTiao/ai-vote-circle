generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  secondmeUserId String          @unique @map("secondme_user_id")
  accessToken    String?         @map("access_token")
  refreshToken   String?         @map("refresh_token")
  tokenExpiresAt DateTime        @map("token_expires_at")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  avatar         String?
  nickname       String?
  voteResponses  VoteResponse[]
  votes          Vote[]
  autoVoteJobs   AutoVoteJob[]
  favorites      Favorite[]

  @@map("users")
}

model Vote {
  id             String   @id @default(cuid())
  title          String
  description    String?
  type           String              // single, multiple
  options        Json                // 投票选项数组
  operatorType   String              // human, ai（发起者类型）
  allowChange    Boolean  @default(false)  // 是否允许改票
  expiresAt      DateTime?           // 截止时间（可选）
  activeAt       DateTime @default(now()) @map("active_at")  // 最新活跃时间
  createdBy      String   @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  creator        User              @relation(fields: [createdBy], references: [id])
  responses      VoteResponse[]
  favorites      Favorite[]

  @@map("votes")
}

model VoteResponse {
  id           String   @id @default(cuid())
  voteId       String   @map("vote_id")
  userId       String   @map("user_id")
  choice       Json     // 选择的答案（单选为数字，多选为数组）
  reason       String?  // 投票理由（可选）
  operatorType String   // human, ai（投票者类型）
  createdAt    DateTime @default(now()) @map("created_at")

  vote         Vote     @relation(fields: [voteId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id])

  // 同一用户可以有多次投票记录（如果允许改票），统计时取最新的
  @@index([voteId, userId, operatorType, createdAt])
  @@map("vote_responses")
}

// 自动投票任务队列
model AutoVoteJob {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  voteId      String   @map("vote_id")
  status      String   @default("pending") // pending, processing, completed, failed
  priority    Int      @default(0) // 优先级，数字越大优先级越高
  error       String?  // 错误信息
  retryCount  Int      @default(0) @map("retry_count") // 重试次数
  createdAt   DateTime @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  user User @relation(fields: [userId], references: [id])

  @@index([status, priority, createdAt])
  @@map("auto_vote_jobs")
}

// Worker 心跳状态表
model WorkerHeartbeat {
  id                String   @id @default(cuid())
  instanceId        String   @unique @map("instance_id") // PM2 进程 ID
  status            String   @default("stopped") // running, stopped, error
  pid               Int?     // 进程 ID
  uptime            Int      @default(0) // 运行时长（秒）
  totalProcessed    Int      @default(0) // 已处理任务总数
  lastActivityAt    DateTime @map("last_activity_at") // 最后活跃时间
  startedAt         DateTime? @map("started_at") // 启动时间
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([status, instanceId])
  @@map("worker_heartbeats")
}

// 收藏表
model Favorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  voteId    String   @map("vote_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  vote Vote @relation(fields: [voteId], references: [id], onDelete: Cascade)

  @@unique([userId, voteId])  // 防止重复收藏
  @@index([userId])
  @@index([voteId])
  @@map("favorites")
}
